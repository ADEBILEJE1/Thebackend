<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Tracking Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        input, button {
            padding: 10px;
            margin: 5px 0;
            width: 100%;
            font-size: 14px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Order Tracking Test</h1>

    <!-- Step 1: Check Email -->
    <div class="section">
        <h2>Step 1: Check Email</h2>
        <input type="text" id="baseUrl" placeholder="Base URL (e.g., http://localhost:8000)" value="http://localhost:8000">
        <input type="email" id="email" placeholder="Customer Email">
        <button onclick="checkEmail()">Check Email</button>
        <pre id="emailResponse"></pre>
    </div>

    <!-- Step 2: Verify PIN (if needed) -->
    <div class="section hidden" id="pinSection">
        <h2>Step 2: Verify PIN</h2>
        <input type="text" id="pin" placeholder="Enter PIN from email">
        <button onclick="verifyPin()">Verify PIN</button>
        <pre id="pinResponse"></pre>
    </div>

    <!-- Step 3: Get Tracking -->
    <div class="section hidden" id="trackingSection">
        <h2>Step 3: Get Order Tracking</h2>
        <p>Session Token: <strong id="sessionToken"></strong></p>
        <button onclick="getTracking()">Get Tracking</button>
        <pre id="trackingResponse"></pre>
    </div>

    <script>
        let baseUrl = '';
        let email = '';
        let sessionToken = '';
        let requiresPin = false;

        async function checkEmail() {
            baseUrl = document.getElementById('baseUrl').value;
            email = document.getElementById('email').value;

            try {
                const response = await fetch(`${baseUrl}/website/addresses/check-email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                });

                const data = await response.json();
                document.getElementById('emailResponse').textContent = JSON.stringify(data, null, 2);

                if (data.requires_pin) {
                    requiresPin = true;
                    document.getElementById('pinSection').classList.remove('hidden');
                } else {
                    sessionToken = data.session_token;
                    document.getElementById('sessionToken').textContent = sessionToken;
                    document.getElementById('trackingSection').classList.remove('hidden');
                }
            } catch (error) {
                document.getElementById('emailResponse').textContent = 'Error: ' + error.message;
            }
        }

        async function verifyPin() {
            const pin = document.getElementById('pin').value;

            try {
                const response = await fetch(`${baseUrl}/website/addresses/verify-and-save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        pin: pin,
                        address_data: {
                            name: "Test",
                            area_id: "dummy",
                            street_address: "Test Address"
                        }
                    })
                });

                const data = await response.json();
                document.getElementById('pinResponse').textContent = JSON.stringify(data, null, 2);

                if (data.session_token) {
                    sessionToken = data.session_token;
                    document.getElementById('sessionToken').textContent = sessionToken;
                    document.getElementById('trackingSection').classList.remove('hidden');
                }
            } catch (error) {
                document.getElementById('pinResponse').textContent = 'Error: ' + error.message;
            }
        }

        async function getTracking() {
            try {
                const response = await fetch(`${baseUrl}/website/orders/tracking?session_token=${sessionToken}`);
                const data = await response.json();
                document.getElementById('trackingResponse').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('trackingResponse').textContent = 'Error: ' + error.message;
            }
        }
    </script>
</body>
</html>